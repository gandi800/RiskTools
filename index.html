<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Gandi800">
    <meta name="theme-color" content="#712cf9">
    <link rel="shortcut icon" href="#">
    
	<link rel="stylesheet" href="./css/bootstrap.min.css" />
	<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs5/dt-1.12.1/datatables.min.css" />
    
	<script src="https://code.jquery.com/jquery-3.6.1.js" integrity="sha256-3zlB5s2uwoUzrXK3BT7AX3FyvojsraNFxCc2vC/7pNI=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs5/dt-1.12.1/datatables.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/alasql@2.1.6/dist/alasql.min.js"></script>
  </head>
  <body>
    <header class="site-header sticky-top py-1">
      <nav class="container d-flex flex-column flex-md-row justify-content-between">
        <div class="col">
          <h5>Risk Global Domination Helper</h5>
        </div>
        <div class="col"><select class="form-select" id="mapSelect">
            <option value="-1">Select Map</option>
          </select></div>
      </nav>
    </header>
    <main>
      <div class="container-fluid">
        <div class="row">
          <div class="col-8"><img class="img-fluid" id="mapImg" src="" /></div>
		  <div class="col-4">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">Connections</h5>
              </div>
              <table id="connecTbl" class="table table-striped">
                <thead>
                  <tr>
                    <th><span>&#10052;</span></th>
                    <th>Territory</th>
                    <th>Direct</th>
                    <th>Linked</th>
                  </tr>
                </thead>
                <tbody>
				</tbody>
              </table>
              <tr>
            </div>
          </div>
        </div>
        <div class="row mt-4">
          <div class="col">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">Continents</h5>
              </div>
              <table id="contTbl" class="table">
                <thead>
                  <tr>
                    <th>Continent</th>
                    <th>Bonus</th>
                    <th>Territories</th>
                  </tr>
                </thead>
                <tbody style="color:black;">
				</tbody>
              </table>
            </div>
          </div>
		  <!-- <div class="col"> -->
            <!-- <div class="card"> -->
              <!-- <div class="card-body"> -->
                <!-- <h5 class="card-title">Territories</h5> -->
              <!-- </div> -->
              <!-- <table id="terTbl" class="table table-striped"> -->
                <!-- <thead> -->
                  <!-- <tr> -->
					<!-- <th>Continent</th> -->
                    <!-- <th>Territory</th> -->
					<!-- <th>Blizzard</th> -->
                  <!-- </tr> -->
                <!-- </thead> -->
                <!-- <tbody> -->
				<!-- </tbody> -->
              <!-- </table> -->
              <!-- <tr> -->
            <!-- </div> -->
          <!-- </div>		  <div class="col"> -->
		  <div class="col">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">To Do</h5>
              </div>
             <ol class="list-group">
			  <li class="list-group-item">Display numbers on map</li>
			  <li class="list-group-item">Add portal calculation</li>
			  <li class="list-group-item">Indicate blizzards and portals by clicking on map</li>
			  <li class="list-group-item">Cap dice calculator</li>
			  <li class="list-group-item">Army dice calculator</li>
			  <li class="list-group-item">Add all maps (will need help from others)</li>
			</ol>
            </div>
          </div>
        </div>
      </div>
      <script>
        
		var mapName = '';
		var conTble;
		var connecTbl;
		<!-- var terTbl; -->
		
		const colors = {
			'red':'#fd7670',
			'blue':'#6f7be6',
			'green':'#8bec8e',
			'yellow':'#f8ebad',
			'teal':'#3fdde9',
			'purple':'#df95f3'
		}
		
        $(document).ready(function() {
          main();
        })
		
        async function main() {
          await CreateTables();
		  initDataTables();
          var maps = await LoadMaps();
          $.each(maps, function() {
            $('#mapSelect').append($('<option>', {
              value: $(this)[0].Map,
              text: $(this)[0].Name
            }));
          });
        }
		
		function initDataTables(){
			conTble = $('#contTbl').DataTable({
				paging: false,
				ordering: true,
				info: false,
				searching: false
			});
			
			<!-- terTbl = $('#terTbl').DataTable({ -->
				<!-- paging: false, -->
				<!-- scrollY: '300px', -->
				<!-- scrollCollapse: true, -->
			<!-- }); -->
			
			connecTbl = $('#connecTbl').DataTable({
				paging: false,
				info: false,
				scrollY: '400px'
			});
		}
		
        async function CreateTables() {
          alasql("CREATE TABLE Maps (Map string, Name string, Blizzards number, Portals number, TotalTerritories number, TotalContinents number)");
          alasql("CREATE TABLE Continents (Map string ,Continent string, TroopBonus number, Color string, TerritoryCount number)");
          alasql("CREATE TABLE Territories (Map string, TerritoryName string, Continent string)");
          alasql("CREATE TABLE Connections (Map string, TerritoryName string, ConenctedTerritory string)");
          alasql("CREATE TABLE TmpConnections (Map string, TerritoryName string, ConenctedTerritory string)");
          alasql("CREATE TABLE Blizzards (BlizzardTerritoryName string)");
        }
		
        async function LoadMaps() {
          await alasql.promise(`SELECT * INTO Maps FROM CSV("data/maps.csv", {headers:true})`);
          return await alasql(`SELECT * FROM Maps`);
        }
		
        async function LoadContinents() {
		  
		  await alasql.promise(`DELETE FROM Continents`);
		  await alasql.promise(`SELECT * INTO Continents FROM CSV("data/` + map + `/continents.csv", {headers:true})`)

          conTble.rows().remove().draw();

          $.each(alasql(`SELECT * FROM Continents`), function() {
			var row = conTble.row.add( [$(this)[0].Continent,$(this)[0].TroopBonus,$(this)[0].TerritoryCount,$(this)[0].Color] ).draw().node();
			$(row).css('background-color',colors[$(this)[0].Color]);
          })
        }
		
        async function LoadTerritories() {
          await alasql.promise(`DELETE FROM Territories`);
          await alasql.promise(`SELECT * INTO Territories FROM CSV("data/` + map + `/territories.csv", {headers:true})`)
        }
		
        async function Loadconnections() {
			await alasql.promise(`DELETE FROM Connections`);
			await alasql.promise(`SELECT * INTO Connections FROM CSV("data/` + map + `/connections.csv", {headers:true})`);
			CalcConnections();
        }
		
		async function CalcConnections(){
		
			$.each($('.blizzard:checked'),async function(){
				await alasql.promise(`INSERT INTO Blizzards VALUES('` + $(this).val() + `')`);
			});			
		
			connecTbl.rows().remove().draw();
		  
			await alasql.promise(`DELETE FROM TmpConnections`);
			await alasql.promise(`
				INSERT INTO TmpConnections
				SELECT 
					c.Map, 
					c.TerritoryName, 
					c.ConenctedTerritory
				FROM 
					Connections c
				LEFT JOIN Blizzards b 
					ON c.TerritoryName = b.BlizzardTerritoryName 
						OR c.ConenctedTerritory = b.BlizzardTerritoryName
				
				WHERE b.BlizzardTerritoryName IS NULL
				
						
				
			`);
		
		  
			$.each(alasql(`
				SELECT 
					t.TerritoryName,
					c.Color,
					b.BlizzardTerritoryName Checked,
					COUNT(DISTINCT c1.ConenctedTerritory) Direct,
					COUNT(c2.ConenctedTerritory) Linked
					
				FROM Territories t
					INNER JOIN Continents c on t.Continent = c.Continent
					LEFT JOIN TmpConnections c1 on t.TerritoryName = c1.TerritoryName
					LEFT JOIN TmpConnections c2 on c1.ConenctedTerritory = c2.TerritoryName
					LEFT JOIN Blizzards b on t.TerritoryName = b.BlizzardTerritoryName
				
				
				GROUP BY
					t.TerritoryName,
					c.Color,
					b.BlizzardTerritoryName
				
			`), function() {
			var color;
			var name;
			if($(this)[0].Direct == 0 && $(this)[0].Linked == 0){
				color = "#C2E0F9";
				name = "<span>&#10052;</span> " + $(this)[0].TerritoryName + " <span>&#10052;</span>";
			} else {
				color = colors[$(this)[0].Color];
				name = $(this)[0].TerritoryName;
			}
			

			var row = connecTbl.row.add([
				'<input type="checkbox"' + ($(this)[0].Checked ? ' checked ' : '') + 'class="blizzard" value="' + $(this)[0].TerritoryName +'" />',
				'<span style="color:' + color + '">' + name + '</span>',
				$(this)[0].Direct == 0 ? "<span>&#10052;</span>" : $(this)[0].Direct ,
				$(this)[0].Linked == 0 ? "<span>&#10052;</span>" : $(this)[0].Linked
			]).draw();
			
			
			
          })
		  
		  await alasql.promise(`DELETE FROM Blizzards`);
		}
		
        $('#mapSelect').change(function() {
            map = $(this).val();
            $('#mapImg').attr("src", `./img/${map}.png`);
            LoadContinents();
            LoadTerritories();
            Loadconnections();
          })
		  
		async function BlizzardUpdate(){
			await CalcConnections();
		}
		  
		  $(document).on("change",".blizzard",function(){
			$(this).attr("checked",true);
				BlizzardUpdate();
		  })
      </script>
    </main>
  </body>
</html>